name: Build and Deploy (Ionic + Capacitor)

on:
push:
branches:
- main
pull_request:
branches:
- main

jobs:
build:
runs-on: ubuntu-latest

steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Use Node.js 20
    uses: actions/setup-node@v4
    with:
      node-version: 20
      cache: "npm"

  - name: Install dependencies
    run: |
      npm ci
      npm install @capacitor/core @capacitor/cli @capacitor/android --save
      npm install maplibre-gl --save

  - name: Build Ionic app
    run: |
      npm run build

  - name: Clean Android platform (to prevent “already exists” error)
    run: |
      rm -rf android
      npx cap add android

  - name: Sync Capacitor
    run: |
      npx cap sync android

  - name: Verify MapLibre integration
    run: |
      grep -q "maplibre-gl" package.json && echo "MapLibre found ✅" || echo "MapLibre missing ❌"

  - name: Build Android
    run: |
      cd android
      ./gradlew assembleDebug

  - name: Upload Android Build Artifact
    uses: actions/upload-artifact@v4
    with:
      name: SafeTripShare-APK
      path: android/app/build/outputs/apk/debug/app-debug.apk