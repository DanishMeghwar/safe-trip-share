name: Rebuild Repo + Build ShareRide APK

on:
  workflow_dispatch:

permissions:
  contents: write   # so the workflow can commit files back

jobs:
  rebuild_and_build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo (with write permission)
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Ensure workspace directories
        run: |
          mkdir -p src/components src/pages

      - name: BACKUP existing files (if any)
        run: |
          mkdir -p backup_before_rebuild
          for f in src/firebaseConfig.ts src/firebaseConfig.js src/components/MapView.tsx src/pages/Login.tsx src/App.tsx capacitor.config.ts capacitor.config.json; do
            if [ -f "$f" ]; then
              echo "Backing up $f"
              mkdir -p "$(dirname "backup_before_rebuild/$f")"
              cp -a "$f" "backup_before_rebuild/$f"
            fi
          done
          git status --porcelain

      - name: Create Capacitor config (typescript)
        run: |
          cat > capacitor.config.ts <<'TS'
import { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  appId: 'com.shareride.app',
  appName: 'ShareRide',
  webDir: 'dist',
  bundledWebRuntime: false,
  plugins: {
    PushNotifications: {
      presentationOptions: ['badge', 'sound', 'alert'],
    },
    SplashScreen: {
      launchShowDuration: 3000,
      launchAutoHide: true,
      backgroundColor: '#ffffff'
    },
    Geolocation: {
      enabled: true
    }
  },
  server: {
    androidScheme: 'https'
  },
  android: {
    path: 'android'
  }
};

export default config;
TS

      - name: Create Firebase config (your confirmed keys)
        run: |
          mkdir -p src
          cat > src/firebaseConfig.ts <<'TS'
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";
import { getFirestore } from "firebase/firestore";

const firebaseConfig = {
  apiKey: "AIzaSyDeErqkvvBfy_u13_a3CLeaMSFcEa9eAq8",
  authDomain: "safe-trip-share.firebaseapp.com",
  projectId: "safe-trip-share",
  storageBucket: "safe-trip-share.firebasestorage.app",
  messagingSenderId: "753357786741",
  appId: "1:753357786741:web:11438217c9b75d22f1b23c",
  measurementId: "G-NHN6K78HK8"
};

const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const googleProvider = new GoogleAuthProvider();
export const db = getFirestore(app);
TS

      - name: Create MapView component (if not present)
        run: |
          mkdir -p src/components
          cat > src/components/MapView.tsx <<'TSX'
import React, { useEffect, useRef } from "react";
import maplibregl from "maplibre-gl";
import "maplibre-gl/dist/maplibre-gl.css";

const MapView: React.FC = () => {
  const container = useRef<HTMLDivElement | null>(null);
  const mapRef = useRef<any>(null);

  useEffect(() => {
    if (mapRef.current) return;
    if (!container.current) return;

    mapRef.current = new maplibregl.Map({
      container: container.current,
      style: "https://demotiles.maplibre.org/style.json",
      center: [68.837, 24.644],
      zoom: 10
    });

    mapRef.current.addControl(new maplibregl.NavigationControl(), "top-right");

    return () => {
      if (mapRef.current) {
        mapRef.current.remove();
        mapRef.current = null;
      }
    };
  }, []);

  return <div ref={container} style={{ width: "100%", height: "100vh" }} />;
};

export default MapView;
TSX

      - name: Create simple Login page (if not present)
        run: |
          mkdir -p src/pages
          cat > src/pages/Login.tsx <<'TSX'
import React, { useState } from "react";
import { auth, googleProvider } from "../firebaseConfig";
import { signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup } from "firebase/auth";

const Login: React.FC = () => {
  const [email, setEmail] = useState("");
  const [pw, setPw] = useState("");

  const handleEmail = async () => {
    try {
      const res = await signInWithEmailAndPassword(auth, email, pw);
      alert("Welcome " + res.user.email);
    } catch (e) {
      try {
        const res2 = await createUserWithEmailAndPassword(auth, email, pw);
        alert("User created: " + res2.user.email);
      } catch (err) {
        alert(err);
      }
    }
  };

  const handleGoogle = async () => {
    try {
      const r = await signInWithPopup(auth, googleProvider);
      alert("Welcome " + r.user.displayName);
    } catch (err) {
      alert(err);
    }
  };

  return (
    <div style={{ padding: 20 }}>
      <h2>ShareRide â€” Login</h2>
      <input placeholder="Email" value={email} onChange={(e)=>setEmail(e.target.value)} /><br/>
      <input placeholder="Password" type="password" value={pw} onChange={(e)=>setPw(e.target.value)} /><br/>
      <button onClick={handleEmail}>Login / Signup</button>
      <hr/>
      <button onClick={handleGoogle}>Sign in with Google</button>
    </div>
  );
};

export default Login;
TSX

      - name: Optionally replace App.tsx to show Login + Map (back up first)
        run: |
          if [ -f src/App.tsx ]; then
            cp src/App.tsx src/App.tsx.bak_from_action || true
          fi
          cat > src/App.tsx <<'TSX'
import React from "react";
import Login from "./pages/Login";
import MapView from "./components/MapView";

function App() {
  return (
    <div>
      <h1 style={{textAlign: 'center'}}>ShareRide</h1>
      <Login />
      <div style={{height: '60vh', marginTop: 20}}>
        <MapView />
      </div>
    </div>
  );
}

export default App;
TSX

      - name: Add required deps (firebase, maplibre, capacitor plugins)
        run: |
          npm set progress=false
          npm install firebase@^11.0.0 maplibre-gl@^3.6.2 @capacitor/core @capacitor/cli @capacitor/android @capacitor/geolocation @capacitor/push-notifications --no-audit --no-fund
          # ensure types exist if TS project
          npm install --save-dev @types/maplibre-gl || true

      - name: Build web assets
        run: |
          npm run build --if-present
          # Ensure dist exists for Capacitor
          if [ ! -d dist ]; then
            mkdir -p dist
            echo "<!doctype html><html><body><h1>ShareRide</h1></body></html>" > dist/index.html
          fi

      - name: Recreate Android clean and add platform
        env:
          CAPACITOR_NEXT: 1
        run: |
          rm -rf android
          npx cap add android
          mkdir -p android/app/src/main/assets
          # ensure capacitor config json used by some plugins
          cat > android/app/src/main/assets/capacitor.config.json <<'JSON'
{"appId":"com.shareride.app","appName":"ShareRide","webDir":"dist","bundledWebRuntime":false}
JSON

      - name: Sync Capacitor (copy web assets + plugins)
        run: |
          npx cap sync android

      - name: Force Java compatibility to 17 (avoid source release 21)
        run: |
          # set compile options in app build.gradle if present
          if [ -f android/app/build.gradle ]; then
            sed -i "s/sourceCompatibility = JavaVersion.VERSION_21/sourceCompatibility = JavaVersion.VERSION_17/g" android/app/build.gradle || true
            sed -i "s/targetCompatibility = JavaVersion.VERSION_21/targetCompatibility = JavaVersion.VERSION_17/g" android/app/build.gradle || true
            # kotlin jvm target
            sed -i "s/jvmTarget = \"21\"/jvmTarget = \"17\"/g" android/app/build.gradle || true
          fi
          # Also set in gradle.properties (org.gradle.java.home not required on runner)
          echo "org.gradle.jvmargs=-Xmx1536m" >> android/gradle.properties || true

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build Android APK
        run: |
          cd android
          chmod +x ./gradlew
          ./gradlew clean assembleDebug --no-daemon -Dorg.gradle.jvmargs="-Xmx1536m"

      - name: Commit created files (capacitor + firebase + map view) back to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "ci: add native-ready capacitor config, firebase & maplibre scaffolding (auto-generated by workflow)" || echo "Nothing to commit"
          git push || echo "Push failed (maybe protected branch)"

      - name: Upload built APK
        uses: actions/upload-artifact@v4
        with:
          name: SafeRide-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
