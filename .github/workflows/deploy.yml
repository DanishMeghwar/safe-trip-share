name: Build and Deploy (Ionic + Capacitor)

on:
push:
branches:
- main
pull_request:
branches:
- main

jobs:
build:
runs-on: ubuntu-latest

steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Sync Android Platform
  run: |
      npx cap sync android
    fi

  - name: Install dependencies
    run: |
      npm ci
      npm install @capacitor/core @capacitor/cli @capacitor/android --save
      npm install maplibre-gl --save

  - name: Build Ionic app
    run: |
      npm run build

  - name: Add or Sync Android Platform
  run: |
    if [ -d "android" ]; then
      npx cap sync android
    else
      npx cap add android
      npx cap sync android
    

  - name: Sync Capacitor
    run: |
      npx cap sync android

  - name: Verify MapLibre integration
    run: |
      grep -q "maplibre-gl" package.json && echo "MapLibre found ✅" || echo "MapLibre missing ❌"

  - name: Build Android
    run: |
      cd android
      ./gradlew assembleDebug

  - name: Upload Android Build Artifact
    uses: actions/upload-artifact@v4
    with:
      name: SafeTripShare-APK
      path: android/app/build/outputs/apk/debug/app-debug.apk
